<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B MONEY - Live Chat</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- FIREBASE SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #FFD700;
            --primary-dark: #B8860B;
            --bg-dark: #050505;
            --bg-card: #121212;
            --text-light: #FFFFFF;
            --text-gray: #B0B0B0;
            --green: #00E676;
            --red: #FF3D00;
            --orange: #FFAB00;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --msg-sent: #FFD700;
            --msg-recv: #333;
        }

        /* --- RESET & BASE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-dark); color: var(--text-light); padding-bottom: 90px; overflow-x: hidden; min-height: 100vh; }
        .hidden { display: none !important; }
        
        /* --- LOGO --- */
        .b-money-logo {
            font-family: 'Oswald', sans-serif;
            font-size: 2.8rem;
            letter-spacing: 2px;
            font-weight: 700;
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            background-size: 200% auto;
            color: #fff;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 4s linear infinite;
            text-align: center;
            margin-bottom: 10px;
        }
        @keyframes shine { to { background-position: 200% center; } }
        
        /* --- BUTTONS --- */
        .btn { 
            padding: 14px 20px; border: none; border-radius: 50px; cursor: pointer; 
            font-weight: 700; transition: all 0.2s ease; width: 100%; font-size: 1rem; 
            text-transform: uppercase; letter-spacing: 1px; background: #333; color: #fff; margin-top: 15px;
        }
        .btn-primary { 
            background: linear-gradient(45deg, #FFD700, #FDB931); color: #000; 
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-small { padding: 8px 16px; font-size: 0.8rem; width: auto; margin-top: 0; }
        .btn-claim { background: linear-gradient(45deg, #00E676, #00C853); color: #000; box-shadow: 0 4px 10px rgba(0, 230, 118, 0.3); }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            background: #1a1a1a;
            border-radius: 30px;
            padding: 4px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .toggle-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            transition: 0.3s;
        }
        .toggle-btn.active {
            background: var(--primary);
            color: #000;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.2);
        }

        /* --- AUTH SCREEN --- */
        #auth-section { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            min-height: 100vh; padding: 20px; background: radial-gradient(circle at center, #1a1a1a, #000); 
        }
        .auth-card { 
            background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(20px);
            padding: 40px 25px; border-radius: 25px; width: 100%; max-width: 360px; 
            text-align: center; border: 1px solid rgba(255, 215, 0, 0.2);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.8rem; color: #aaa; margin-left: 10px; }
        .auth-card input { 
            width: 100%; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid #333; 
            color: white; border-radius: 12px; outline: none; transition: 0.3s; font-size: 1rem;
        }
        .switch-auth { margin-top: 20px; color: #888; font-size: 0.85rem; cursor: pointer; }

        /* --- HEADER --- */
        header { 
            background: rgba(5, 5, 5, 0.9); padding: 15px 20px; display: flex; justify-content: space-between; 
            align-items: center; border-bottom: 1px solid #222; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px);
        }
        .logo-text { font-family: 'Oswald', sans-serif; font-size: 1.5rem; font-weight: bold; color: var(--primary); letter-spacing: 1px;}

        /* --- DASHBOARD --- */
        .balance-card { 
            background: linear-gradient(135deg, #1f1f1f, #111); 
            border: 1px solid #333; margin: 20px 15px; padding: 30px; border-radius: 20px; 
            text-align: center; position: relative; overflow: hidden;
        }
        .balance-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,215,0,0.05) 0%, transparent 70%);
        }
        .balance-amount { font-size: 3rem; font-weight: 800; color: #fff; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .currency { font-size: 1.2rem; color: var(--primary); vertical-align: top; margin-right: 5px; }

        .section-title { padding: 0 25px; color: #666; font-size: 0.8rem; text-transform: uppercase; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between;}
        
        /* Plan Cards */
        .plans-container { display: grid; grid-template-columns: 1fr; gap: 15px; padding: 0 15px 20px 15px; }
        .plan-card { 
            background: #151515; border: 1px solid #2a2a2a; padding: 20px; border-radius: 16px; 
            text-align: center; transition: 0.3s; position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .plan-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .plan-name { color: var(--primary); font-weight: bold; font-size: 1.1rem; }
        .plan-price { color: #fff; font-size: 1.2rem; font-weight: 700; }
        
        .income-box {
            background: rgba(0, 230, 118, 0.1);
            border: 1px solid rgba(0, 230, 118, 0.2);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: left;
        }
        .income-val { font-size: 1.4rem; color: var(--green); font-weight: bold; }
        .timer-text { font-size: 0.8rem; color: var(--orange); margin-bottom: 10px; display: block; }

        /* Forms */
        .form-section { padding: 20px; }
        .form-control { width: 100%; padding: 16px; background: #111; border: 1px solid #333; color: white; border-radius: 12px; margin-bottom: 15px; outline: none; font-size: 1rem; }
        .form-control:focus { border-color: var(--primary); }
        select.form-control { appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFD700%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 0.8rem; }
        
        .info-box { background: rgba(255, 215, 0, 0.05); padding: 15px; border-left: 4px solid var(--primary); margin-bottom: 20px; border-radius: 8px; font-size: 0.9rem; color: #ddd;}

        /* --- CHAT INTERFACE (NEW) --- */
        .chat-container {
            display: flex; flex-direction: column; height: calc(100vh - 140px);
        }
        .chat-messages {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;
        }
        .message {
            max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 0.9rem; line-height: 1.4; position: relative;
        }
        .message.sent {
            align-self: flex-end; background: var(--msg-sent); color: #000; border-bottom-right-radius: 2px;
        }
        .message.received {
            align-self: flex-start; background: var(--msg-recv); color: #fff; border-bottom-left-radius: 2px;
        }
        .msg-time {
            font-size: 0.65rem; opacity: 0.7; margin-top: 5px; display: block; text-align: right;
        }
        .chat-input-area {
            padding: 10px; background: #111; border-top: 1px solid #333; display: flex; gap: 10px;
        }
        .chat-input {
            flex: 1; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 25px; outline: none;
        }
        .send-btn {
            background: var(--primary); border: none; color: black; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* --- HISTORY LISTS --- */
        .history-list { max-height: 60vh; overflow-y: auto; padding-bottom: 20px; }
        .history-item { background: #151515; border: 1px solid #222; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .h-left { display: flex; flex-direction: column; gap: 4px; }
        .h-method { font-weight: 600; color: #fff; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .h-trx { font-size: 0.75rem; color: #666; font-family: monospace; }
        .h-status { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; display: inline-block; margin-top: 5px; }
        .status-pending { background: rgba(255, 187, 51, 0.15); color: var(--orange); }
        .status-approved { background: rgba(0, 200, 81, 0.15); color: var(--green); }
        .status-rejected { background: rgba(255, 68, 68, 0.15); color: var(--red); }

        /* --- BOTTOM NAV --- */
        .bottom-nav { 
            position: fixed; bottom: 0; width: 100%; background: rgba(5, 5, 5, 0.95); 
            display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #222; 
            z-index: 100; padding-bottom: max(12px, env(safe-area-inset-bottom)); 
            backdrop-filter: blur(10px);
        }
        .nav-item { text-align: center; color: #555; cursor: pointer; flex: 1; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 4px; }
        .nav-label { font-size: 0.7rem; font-weight: 600; }

        /* --- TOAST --- */
        #toast-container { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 999; width: 90%; max-width: 400px; text-align: center; pointer-events: none;}
        .toast {
            background: rgba(30, 30, 30, 0.95); border: 1px solid var(--primary); color: white;
            padding: 12px 20px; border-radius: 30px; margin-bottom: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            opacity: 0; transform: translateY(20px); transition: all 0.4s ease; font-size: 0.9rem; display: inline-block;
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* Shop Grid */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 15px 20px 15px; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- AUTH SECTION -->
    <section id="auth-section">
        <div class="auth-card">
            <div class="b-money-logo">B MONEY</div>
            <h3 id="auth-title" style="margin-bottom: 25px; color: #fff;">Login Account</h3>
            
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="username" placeholder="e.g. bmoney123">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="••••••••">
            </div>
            
            <div class="input-group hidden" id="signup-fields">
                <label>Referral Code (Optional)</label>
                <input type="text" id="ref-code-input" placeholder="Code">
            </div>
            
            <button class="btn btn-primary" id="auth-btn" onclick="handleAuth()">Login Now</button>
            <p class="switch-auth" onclick="toggleAuth()">New User? Create Account</p>
        </div>
    </section>

    <!-- APP SECTION -->
    <section id="app-section" class="hidden">
        <header>
            <div class="logo-text">B MONEY</div>
            <div style="font-size: 0.8rem; color: #888;">
                ID: <span id="user-display-name" style="color:var(--primary); font-weight:600;"></span>
            </div>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard">
            <div class="balance-card">
                <small style="letter-spacing: 3px; color: #888;">TOTAL BALANCE</small>
                <div class="balance-amount"><span class="currency">PKR</span> <span id="display-balance">0</span></div>
            </div>

            <div class="section-title">
                <span>My Active Plans</span>
                <i class="ph ph-trend-up" style="color:var(--primary)"></i>
            </div>
            
            <div class="plans-container" style="padding: 0 15px;">
                <div id="active-plans-list"></div>
            </div>

            <div class="section-title" style="margin-top: 30px;">
                <span>Buy New Plan</span>
                <i class="ph ph-shopping-cart" style="color:var(--primary)"></i>
            </div>
            <div class="shop-grid" id="plans-shop"></div>
        </div>

        <!-- CHAT VIEW (NEW) -->
        <div id="view-chat" class="hidden chat-container">
            <div class="chat-messages" id="chat-list">
                <!-- Messages Load Here -->
                <div style="text-align:center; color:#555; margin-top:20px;">Support is online.</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="msg-input" class="chat-input" placeholder="Type a message...">
                <button class="send-btn" onclick="sendMessage()">
                    <i class="ph ph-paper-plane-right" style="font-size:1.2rem; color:black;"></i>
                </button>
            </div>
        </div>

        <!-- DEPOSIT VIEW -->
        <div id="view-deposit" class="hidden">
            <div class="form-section">
                <h2 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="ph ph-wallet"></i> Add Funds
                </h2>
                <div class="toggle-container">
                    <div class="toggle-btn active" id="dep-btn-req" onclick="switchDepWith('dep', 'req')">Request</div>
                    <div class="toggle-btn" id="dep-btn-hist" onclick="switchDepWith('dep', 'hist')">History</div>
                </div>

                <div id="dep-form-container">
                    <div class="info-box">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <strong>Easypaisa:</strong> <span>03403874715</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <strong>JazzCash:</strong> <span>Maintenance</span>
                        </div>
                    </div>
                    <select id="dep-method" class="form-control">
                        <option value="Easypaisa">Easypaisa</option>
                        <option value="JazzCash">JazzCash</option>
                    </select>
                    <input type="number" id="dep-amount" class="form-control" placeholder="Amount (PKR)">
                    <input type="text" id="dep-trx" class="form-control" placeholder="Transaction ID">
                    <button class="btn btn-primary" onclick="submitDeposit()">Submit Request</button>
                </div>

                <div id="dep-history-container" class="hidden">
                    <div class="history-list" id="deposit-history-list"></div>
                </div>
            </div>
        </div>

        <!-- WITHDRAW VIEW -->
        <div id="view-withdraw" class="hidden">
            <div class="form-section">
                <h2 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="ph ph-money"></i> Withdraw Funds
                </h2>
                <div class="toggle-container">
                    <div class="toggle-btn active" id="with-btn-req" onclick="switchDepWith('with', 'req')">Request</div>
                    <div class="toggle-btn" id="with-btn-hist" onclick="switchDepWith('with', 'hist')">History</div>
                </div>

                <div id="with-form-container">
                    <div class="info-box">
                        Available Balance: <span style="color:var(--primary); font-weight:bold; font-size:1.1rem;">PKR <span id="withdraw-avail">0</span></span>
                    </div>
                    <input type="number" id="with-account" class="form-control" placeholder="Account Number (03XX...)">
                    <input type="number" id="with-amount" class="form-control" placeholder="Amount (Min 500)">
                    <select id="with-method" class="form-control">
                        <option value="Easypaisa">Easypaisa</option>
                        <option value="JazzCash">JazzCash</option>
                    </select>
                    <button class="btn btn-primary" onclick="submitWithdraw()">Withdraw Now</button>
                </div>

                <div id="with-history-container" class="hidden">
                    <div class="history-list" id="withdraw-history-list"></div>
                </div>
            </div>
        </div>

        <!-- INVITE VIEW -->
        <div id="view-invite" class="hidden">
            <div class="form-section">
                <h2 style="color: var(--primary); text-align: center; margin-bottom: 30px;">Invite & Earn</h2>
                <div class="info-box" style="text-align: center; padding: 30px;">
                    <p style="color:#888; font-size:0.8rem; margin-bottom:10px;">YOUR REFERRAL CODE</p>
                    <h1 id="my-ref-code" style="font-size: 1.5rem; color: #fff; margin: 10px 0; letter-spacing: 2px;">...</h1>
                    <button class="btn btn-primary btn-small" onclick="copyCode()">Copy Code</button>
                </div>
                <div class="info-box">
                    <p><strong>How it works:</strong><br>Share your code. When a friend joins and deposits, you get a commission 30% bonus!</p>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchView('dashboard', this)">
                <i class="ph ph-house nav-icon"></i>
                <span class="nav-label">Home</span>
            </div>
            <div class="nav-item" onclick="switchView('chat', this)">
                <i class="ph ph-chat-circle-dots nav-icon"></i>
                <span class="nav-label">Live Chat</span>
            </div>
            <div class="nav-item" onclick="switchView('deposit', this)">
                <i class="ph ph-download-simple nav-icon"></i>
                <span class="nav-label">Deposit</span>
            </div>
            <div class="nav-item" onclick="switchView('withdraw', this)">
                <i class="ph ph-upload-simple nav-icon"></i>
                <span class="nav-label">Withdraw</span>
            </div>
            <div class="nav-item" onclick="switchView('invite', this)">
                <i class="ph ph-users nav-icon"></i>
                <span class="nav-label">Invite</span>
            </div>
        </div>
    </section>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 1. CONFIG & STATE ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7atEHWnOo_EzCuFxBRg4xWF51x4atfRQ",
            authDomain: "wingo-new-pro.firebaseapp.com",
            databaseURL: "https://wingo-new-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "wingo-new-pro",
            storageBucket: "wingo-new-pro.firebasestorage.app",
            messagingSenderId: "574707809146",
            appId: "1:574707809146:web:fb0d53fc0a202c4d2934c3",
            measurementId: "G-WED3TVXE62"
        };

        let db, currentUser, isLoginMode = true, isSimulating = false;
        let simData = { users: {}, depositRequests: {}, withdrawRequests: {}, chatMessages: [] };

        // Initialize
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } catch(e) {
            console.warn("Firebase init failed, switching to Simulation Mode");
            isSimulating = true;
        }

        // --- 2. UI HELPERS ---
        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = msg;
            container.appendChild(toast);
            void toast.offsetWidth;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        function switchView(viewName, navEl) {
            ['dashboard', 'chat', 'deposit', 'withdraw', 'invite'].forEach(v => {
                document.getElementById('view-' + v).classList.add('hidden');
            });
            document.getElementById('view-' + viewName).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');

            if(viewName === 'deposit') loadDepositHistory();
            if(viewName === 'withdraw') loadWithdrawHistory();
            if(viewName === 'chat') loadChatMessages();
        }

        function switchDepWith(type, mode) {
            const formCont = document.getElementById(type + '-form-container');
            const histCont = document.getElementById(type + '-history-container');
            const btnReq = document.getElementById(type + '-btn-req');
            const btnHist = document.getElementById(type + '-btn-hist');

            if(mode === 'req') {
                formCont.classList.remove('hidden');
                histCont.classList.add('hidden');
                btnReq.classList.add('active');
                btnHist.classList.remove('active');
            } else {
                formCont.classList.add('hidden');
                histCont.classList.remove('hidden');
                btnReq.classList.remove('active');
                btnHist.classList.add('active');
                if(type === 'dep') loadDepositHistory();
                if(type === 'with') loadWithdrawHistory();
            }
        }

        // --- 3. AUTH LOGIC ---
        function toggleAuth() {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('auth-title');
            const btn = document.getElementById('auth-btn');
            const switchText = document.querySelector('.switch-auth');
            const signupFields = document.getElementById('signup-fields');

            if (isLoginMode) {
                title.innerText = "Login Account";
                btn.innerText = "Login Now";
                switchText.innerText = "New User? Create Account";
                signupFields.classList.add('hidden');
            } else {
                title.innerText = "Create Account";
                btn.innerText = "Register Now";
                switchText.innerText = "Already have account? Login";
                signupFields.classList.remove('hidden');
            }
        }

        function handleAuth() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const refCode = document.getElementById('ref-code-input').value.trim();

            if (!username || !password) return showToast("Please fill all fields");

            const btn = document.getElementById('auth-btn');
            btn.innerText = "Processing...";
            btn.disabled = true;

            if (isSimulating) {
                setTimeout(() => {
                    let user = simData.users[username];
                    if (isLoginMode) {
                        if (user && user.password === password) loginSuccess(username);
                        else showToast("Wrong credentials (Sim)");
                    } else {
                        if (user) { showToast("User taken"); }
                        else {
                            simData.users[username] = { password, balance: 1000, referralCode: username.toUpperCase()+'123', plans: {} };
                            loginSuccess(username);
                        }
                    }
                    btn.innerText = "Login Now"; btn.disabled = false;
                }, 1000);
                return;
            }

            // Real Firebase Logic
            if (isLoginMode) {
                db.ref('users/' + username).once('value')
                .then(snap => {
                    if (snap.exists() && snap.val().password === password) loginSuccess(username);
                    else showToast("Invalid Credentials");
                }).finally(() => { btn.innerText = "Login Now"; btn.disabled = false; });
            } else {
                db.ref('users/' + username).once('value').then(snap => {
                    if (snap.exists()) throw "User exists";
                    return db.ref('users/' + username).set({
                        password, balance: 0, referralCode: username + Math.floor(Math.random()*1000), plans: {}
                    });
                }).then(() => loginSuccess(username))
                .catch(e => showToast(e))
                .finally(() => { btn.innerText = "Register Now"; btn.disabled = false; });
            }
        }

        function loginSuccess(username) {
            currentUser = username;
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = username;
            
            listenUserData();
            listenDepositHistory();
            listenWithdrawHistory();
            listenChat(); // Start listening to chat
        }

        // --- 4. CHAT LOGIC (NEW) ---
        function listenChat() {
            const list = document.getElementById('chat-list');
            
            if(isSimulating) {
                // Init sim chat if empty
                if(simData.chatMessages.length === 0) {
                    simData.chatMessages.push({ text: "Hello! How can I help you today?", sender: "admin", time: new Date().toISOString() });
                }
                loadChatMessages();
            } else {
                // Realtime listener
                db.ref('chat').on('value', snap => {
                    const data = snap.val();
                    list.innerHTML = "";
                    if(data) {
                        Object.values(data).forEach(msg => {
                            const isMe = msg.sender === currentUser;
                            const typeClass = isMe ? 'sent' : 'received';
                            const date = msg.time ? new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                            
                            list.innerHTML += `
                            <div class="message ${typeClass}">
                                ${msg.text}
                                <span class="msg-time">${date}</span>
                            </div>`;
                        });
                    }
                    // Auto scroll
                    list.scrollTop = list.scrollHeight;
                });
            }
        }

        function loadChatMessages() {
            // Used for simulation or manual refresh
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            if(isSimulating && simData.chatMessages) {
                simData.chatMessages.forEach(msg => {
                    const isMe = msg.sender === currentUser;
                    const typeClass = isMe ? 'sent' : 'received';
                    const date = msg.time ? new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                    
                    list.innerHTML += `
                    <div class="message ${typeClass}">
                        ${msg.text}
                        <span class="msg-time">${date}</span>
                    </div>`;
                });
                list.scrollTop = list.scrollHeight;
            }
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            const msgObj = {
                text: text,
                sender: currentUser,
                time: new Date().toISOString()
            };

            if(isSimulating) {
                simData.chatMessages.push(msgObj);
                loadChatMessages();
                input.value = "";
                
                // Fake Admin Reply
                setTimeout(() => {
                    simData.chatMessages.push({
                        text: "Thanks for your message! An agent will reply shortly.",
                        sender: "admin",
                        time: new Date().toISOString()
                    });
                    loadChatMessages();
                }, 2000);
            } else {
                db.ref('chat').push(msgObj).then(() => {
                    input.value = "";
                });
            }
        }

        // --- 5. DATA LISTENERS & PLAN LOGIC ---
        function listenUserData() {
            const updateUI = (data) => {
                if(!data) return;
                document.getElementById('display-balance').innerText = Math.floor(data.balance || 0);
                document.getElementById('withdraw-avail').innerText = Math.floor(data.balance || 0);
                document.getElementById('my-ref-code').innerText = data.referralCode || "N/A";
                renderActivePlans(data.plans || {});
            };

            if(isSimulating) updateUI(simData.users[currentUser]);
            else db.ref('users/' + currentUser).on('value', snap => updateUI(snap.val()));
        }

        function renderActivePlans(plans) {
            const listDiv = document.getElementById('active-plans-list');
            listDiv.innerHTML = "";
            const planKeys = Object.keys(plans);

            if (planKeys.length === 0) {
                listDiv.innerHTML = `<div style="text-align:center; color:#444; padding:20px; border:1px dashed #333; border-radius:10px;">No active plans. Buy a plan to start earning daily!</div>`;
                return;
            }

            const now = new Date().getTime();

            planKeys.forEach(key => {
                const p = plans[key];
                const purchaseDate = p.startDate ? new Date(p.startDate).getTime() : now;
                const msPerDay = 86400000;
                const daysPassed = Math.floor((now - purchaseDate) / msPerDay);
                const dailyIncome = Math.floor((p.amount * p.roi) / 100);
                const totalPending = dailyIncome * daysPassed;
                
                const nextClaimTime = purchaseDate + ((daysPassed + 1) * msPerDay);
                const timeLeftMs = nextClaimTime - now;
                let hoursLeft = Math.floor((timeLeftMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                let minsLeft = Math.floor((timeLeftMs % (1000 * 60 * 60)) / (1000 * 60));
                const isReady = totalPending > 0;

                const html = `
                <div class="plan-card">
                    <div class="plan-header">
                        <div class="plan-name">${p.name}</div>
                        <div class="plan-price">PKR ${p.amount}</div>
                    </div>
                    
                    <div class="income-box">
                        <span class="income-label">Available Income</span>
                        <div class="income-val">PKR ${totalPending}</div>
                    </div>

                    ${isReady ? 
                        `<button class="btn btn-primary btn-claim" onclick="claimIncome('${key}')">Claim Income</button>` : 
                        `<span class="timer-text"><i class="ph ph-clock"></i> Next income in: ${hoursLeft}h ${minsLeft}m</span>`
                    }
                </div>`;
                listDiv.innerHTML += html;
            });
        }

        function claimIncome(planKey) {
            const process = (userData) => {
                const p = userData.plans[planKey];
                const now = new Date().getTime();
                const purchaseDate = new Date(p.startDate).getTime();
                const daysPassed = Math.floor((now - purchaseDate) / 86400000);
                const dailyIncome = Math.floor((p.amount * p.roi) / 100);
                const totalPending = dailyIncome * daysPassed;

                if(totalPending <= 0) return showToast("No income available yet.");

                const updates = {
                    ['users/' + currentUser + '/balance']: userData.balance + totalPending,
                    ['users/' + currentUser + '/plans/' + planKey + '/startDate']: new Date().toISOString()
                };

                if(isSimulating) {
                    simData.users[currentUser].balance += totalPending;
                    simData.users[currentUser].plans[planKey].startDate = new Date().toISOString();
                    listenUserData();
                    showToast(`PKR ${totalPending} Claimed!`);
                } else {
                    db.ref().update(updates).then(() => showToast(`PKR ${totalPending} Claimed!`));
                }
            };

            if(isSimulating) process(simData.users[currentUser]);
            else db.ref('users/' + currentUser).once('value').then(snap => process(snap.val()));
        }

        function buyPlan(name, price, roi) {
            const process = (userData) => {
                if(userData.balance < price) return showToast("Insufficient Balance!");
                const newPlan = { name, amount: price, roi, startDate: new Date().toISOString() };
                
                if(isSimulating) {
                    simData.users[currentUser].balance -= price;
                    const pid = 'plan_' + Date.now();
                    simData.users[currentUser].plans[pid] = newPlan;
                    listenUserData();
                    showToast("Plan Activated! Claim income after 24h.");
                } else {
                    const updates = {
                        ['users/' + currentUser + '/balance']: userData.balance - price,
                        ['users/' + currentUser + '/plans/' + Date.now()]: newPlan
                    };
                    db.ref().update(updates).then(() => showToast("Plan Activated! Claim income after 24h."));
                }
            };

            if(isSimulating) process(simData.users[currentUser]);
            else db.ref('users/' + currentUser).once('value').then(s => process(s.val()));
        }

        // --- 6. HISTORY LOGIC ---
        function listenDepositHistory() {
            if(isSimulating) return;
            db.ref('depositRequests').on('value', s => renderHistory(s.val(), 'deposit'));
        }
        function loadDepositHistory() { if(isSimulating) renderHistory(simData.depositRequests, 'deposit'); }
        
        function listenWithdrawHistory() {
            if(isSimulating) return;
            db.ref('withdrawRequests').on('value', s => renderHistory(s.val(), 'withdraw'));
        }
        function loadWithdrawHistory() { if(isSimulating) renderHistory(simData.withdrawRequests, 'withdraw'); }

        function renderHistory(data, type) {
            const container = document.getElementById(type + '-history-list');
            container.innerHTML = "";
            if (!data) { container.innerHTML = `<div style="text-align:center; color:#555; padding:20px;">No history found.</div>`; return; }
            
            Object.entries(data).reverse().forEach(([key, item]) => {
                if (item.user !== currentUser) return;
                const date = item.date ? new Date(item.date).toLocaleDateString() : 'Unknown';
                const statusClass = item.status === 'pending' ? 'status-pending' : (item.status === 'approved' ? 'status-approved' : 'status-rejected');
                const icon = item.method === 'Easypaisa' ? '<i class="ph ph-mobile"></i>' : '<i class="ph ph-bank"></i>';

                container.innerHTML += `
                <div class="history-item">
                    <div class="h-left">
                        <div class="h-method">${icon} ${item.method}</div>
                        <div class="h-trx">ID: ${item.trxId || key.substring(0,8)}</div>
                        <div class="h-date">${date}</div>
                    </div>
                    <div class="h-right">
                        <div class="h-amount">PKR ${item.amount}</div>
                        <div class="h-status ${statusClass}">${item.status.toUpperCase()}</div>
                    </div>
                </div>`;
            });
        }

        // --- 7. DEPOSIT & WITHDRAW ---
        function submitDeposit() {
            const method = document.getElementById('dep-method').value;
            const amount = parseInt(document.getElementById('dep-amount').value);
            const trx = document.getElementById('dep-trx').value;
            if (!amount || !trx) return showToast("Enter Amount & TrxID");

            const reqData = { user: currentUser, method, amount, trxId: trx, status: 'pending', date: new Date().toISOString() };
            const finish = () => {
                showToast("Request Sent!");
                document.getElementById('dep-amount').value = ""; document.getElementById('dep-trx').value = "";
                switchDepWith('dep', 'hist');
            };

            if(isSimulating) { simData.depositRequests['dep_'+Date.now()] = reqData; finish(); }
            else db.ref('depositRequests').push(reqData).then(finish).catch(e => showToast(e.message));
        }

        function submitWithdraw() {
            const amount = parseInt(document.getElementById('with-amount').value);
            const account = document.getElementById('with-account').value;
            const method = document.getElementById('with-method').value;

            const checkBal = (bal) => {
                if(amount > bal) return showToast("Insufficient Balance!");
                if(amount < 500) return showToast("Min withdraw 500");
                const reqData = { user: currentUser, amount, account, method, status: 'pending', date: new Date().toISOString() };
                
                if(isSimulating) {
                    simData.users[currentUser].balance -= amount;
                    listenUserData();
                    simData.withdrawRequests['with_'+Date.now()] = reqData;
                    showToast("Request Sent!");
                    document.getElementById('with-amount').value = ""; switchDepWith('with', 'hist');
                } else {
                    db.ref('users/'+currentUser+'/balance').transaction(b => b - amount)
                    .then(() => db.ref('withdrawRequests').push(reqData))
                    .then(() => { showToast("Request Sent!"); document.getElementById('with-amount').value = ""; switchDepWith('with', 'hist'); })
                    .catch(e => showToast(e.message));
                }
            };

            if(isSimulating) checkBal(simData.users[currentUser].balance);
            else db.ref('users/' + currentUser + '/balance').once('value').then(s => checkBal(s.val()));
        }

        function copyCode() {
            const code = document.getElementById('my-ref-code').innerText;
            navigator.clipboard.writeText(code).then(() => showToast("Code Copied!"));
        }

        // --- 8. POPULATE SHOP ---
        const plansData = [
            { id: 1, name: "Starter", price: 500, roi: 10 },
            { id: 2, name: "Basic", price: 1000, roi: 12 },
            { id: 3, name: "Pro", price: 5000, roi: 15 },
            { id: 4, name: "VIP", price: 10000, roi: 20 },
        ];
        const shopGrid = document.getElementById('plans-shop');
        plansData.forEach(p => {
            shopGrid.innerHTML += `
            <div class="plan-card">
                <div class="plan-header">
                    <div class="plan-name">${p.name}</div>
                    <div class="plan-price">PKR ${p.price}</div>
                </div>
                <div class="plan-roi" style="color:var(--green); margin-bottom:15px;">Daily ${p.roi}%</div>
                <button class="btn btn-primary btn-small" onclick="buyPlan('${p.name}', ${p.price}, ${p.roi})">BUY</button>
            </div>`;
        });

    </script>
</body>
</html>
